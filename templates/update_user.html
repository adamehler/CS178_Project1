<!DOCTYPE html>
<html lang="en">
<head>
    <title>Update User Countries</title>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <style>
        body { font-family: Arial, sans-serif; }
        select { width: 300px; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <h1>Update User's Visited Countries</h1>

    <!-- User selection -->
    <label for="username">Select User:</label><br>
    <select id="username" name="username">
        <option value="">-- Choose a user --</option>
        {% for user in users %}
        <option value="{{ user }}">{{ user }}</option>
        {% endfor %}
    </select><br><br>

    <!-- Dynamic update form -->
    <div id="update-section" class="hidden">
        <form id="update-form" method="POST" action="{{ url_for('update_user') }}">
            <input type="hidden" name="username" id="form-username">
            
            <label for="updatedCountries">Modify Visited Countries:</label><br>
            <select id="updatedCountries" name="updatedCountries" multiple required>
                <!-- Filled dynamically via AJAX -->
            </select><br><br>

            <input type="submit" value="Save Changes">
        </form>
    </div>

    <script>
        $(document).ready(function () {
            $('#username').select2({ placeholder: "Select user..." });
            $('#updatedCountries').select2({ placeholder: "Add or remove countries..." });

            $('#username').on('change', function () {
                const username = $(this).val();
                if (!username) return;

                $.post("/get-user-countries", { username: username }, function (data) {
                    const updated = $('#updatedCountries');
                    updated.empty();

                    const combined = [...data.current_countries, ...data.available_countries];
                    combined.sort();

                    for (let country of combined) {
                        const selected = data.current_countries.includes(country) ? 'selected' : '';
                        updated.append(`<option value="${country}" ${selected}>${country}</option>`);
                    }

                    $('#form-username').val(username);
                    $('#update-section').removeClass('hidden');
                    updated.trigger('change');
                });
            });
        });
    </script>
</body>
</html>
